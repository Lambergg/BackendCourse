from fastapi import APIRouter, Response, Request, Body

from src.api.dependencies import UserIdDep, DBDep
from src.exceptions import UserDeleteTokenHTTPException
from src.schemas.users import UserRequestAdd
from src.services.auth import AuthService

router = APIRouter(prefix="/auth", tags=["–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è"])


@router.post(
    "/register",
    summary="–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    description="<h1>–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å email –∏ –ø–∞—Ä–æ–ª—å</h1>",
)
async def register_user(
    db: DBDep,
    data: UserRequestAdd = Body(
        openapi_examples={
            "1": {
                "summary": "–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                "value": {
                    "email": "koto-pes@mail.ru",
                    "password": "abcd1234",
                },
            }
        }
    ),
):
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - `db`: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö (–∏–Ω—ä–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ DI).
    - `data`: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email –∏ –ø–∞—Ä–æ–ª—å) –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞.

    –õ–æ–≥–∏–∫–∞:
    - –ü–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Ä–≤–∏—Å `AuthService` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
    - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
    - –ò–Ω–∞—á–µ ‚Äî —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - JSON: `{"Status": "Ok"}`
    """
    await AuthService(db).register_user(data)
    return {"Status": "Ok"}


@router.post(
    "/login",
    summary="–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    description="<h1>–î–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å email –∏ –ø–∞—Ä–æ–ª—å</h1>",
)
async def login_user(
    response: Response,
    db: DBDep,
    data: UserRequestAdd = Body(
        openapi_examples={
            "1": {
                "summary": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
                "value": {
                    "email": "koto-pes@mail.ru",
                    "password": "abcd1234",
                },
            }
        }
    ),
):
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º—É.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - `response`: –û–±—ä–µ–∫—Ç HTTP-–æ—Ç–≤–µ—Ç–∞ (–¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookie).
    - `db`: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    - `data`: Email –∏ –ø–∞—Ä–æ–ª—å –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞.

    –õ–æ–≥–∏–∫–∞:
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è.
    - –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JWT-—Ç–æ–∫–µ–Ω –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –µ–≥–æ –≤ `access_token` (cookie).
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏ —Ç–∏–ø (`bearer`) –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - JSON: `{"access_token": "xxx", "token_type": "bearer"}`
    """
    return await AuthService(db).login_user(data, response)


@router.get(
    "/me",
    summary="üßë‚Äçüíª –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ",
    description="<h1>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω</h1>",
)
async def get_me(
    user_id: UserIdDep,
    db: DBDep,
):
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - `user_id`: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å, –∏–∑–≤–ª–µ–∫–∞—é—â–∞—è ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ JWT-—Ç–æ–∫–µ–Ω–∞.
    - `db`: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.

    –õ–æ–≥–∏–∫–∞:
    - –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ `id`.
    - –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø–∞—Ä–æ–ª—è –∏ —Ö–µ—à–∞).
    """
    return await AuthService(db).get_me(user_id)


@router.post(
    "/logout",
    summary="–í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
    description="<h1>–í—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ cookie</h1>",
)
async def logout_user(
    response: Response,
    request: Request,
):
    """
    –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - `response`: –û–±—ä–µ–∫—Ç HTTP-–æ—Ç–≤–µ—Ç–∞.

    –õ–æ–≥–∏–∫–∞:
    - –£–¥–∞–ª—è–µ—Ç cookie `access_token`.

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - JSON: `{"Status": "Ok"}`
    """
    token = request.cookies.get("access_token") or None
    if not token:
        raise UserDeleteTokenHTTPException
    response.delete_cookie("access_token")
    return {"Status": "Ok"}
